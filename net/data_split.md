### TCP/IP 数据拆分

我在另外一个地方说到了TCP的数据粘包，这里再展开说下TCP/IP协议簇的处理。

当应用层协议使用TCP/IP协议进行数据传输的时候，TCP/IP协议簇可能会将应用层发送的数据分成多个包依次发送，这个时候，数据的接收方收到的数据可能是
分段或者拼接的，所以它需要对接收到的数据进行拆分/重组，至于数据为什么要被拆分发送，基本就是两个点：

- IP协议会分片传输过大的数据包避免物理设备的限制（Packet）
- TCP 协议分段传输过大的数据段保证传输的性能（Segment）

#### IP协议拆分数据 ： 最大传输单元

IP 协议是用于传输数据包的协议，作为网络层协议，它能提供给数据的路由和寻址功能，让数据通过网络达到目的地。不通过设备之间传输数据之前，需要先
确定一个IP数据包到大小上限，即最大传输单元（maximum transmission unit, MTU）,也就是IP数据包能够传输到数据上限。

MTU的值并不是越大越好，更大的MTU意味着更低的额外开销，但是相反的更小的MTU却可以带来更低的网络延迟。每一个物理设备都有自己的MTU，两个主机之间
的MTU依赖于底层的网络能力，由最小MTU的物理设备决定。

注： 路径最大传输单元发现（Path MTU Discovery）可以用来确定两个主机传输路径MTU的机制：

1. 向目的主机发送IP头中DF（don't fragment，不分片）控制位为1对数据包，路径上的网络设备根据数据包的大小和自己的MTU作出不同的决定，小于本身的MTU就继续往下传递，大于就返回ICMP消息（互联网控制消息协议，可以在IP主机之间传递控制信息）；
2. 源主机收到ICMP消息后，会不断使用新的MTU发送IP数据包，直到IP数据包达到目的主机；

以太网对数据帧的限制一般都是1500字节，在一般情况下，IP主机的路径MTU都是1500，去掉IP首部的 20 字节，如果待传输的数据大于1480节，那么该IP协议就会将数据包分片传输。

IP协议数据分片对传输层协议是透明的，假设我们使用UDP协议传输2000字节的数据，加上UDP 8字节的协议头，IP协议需要传输 2008 字节的数据。

如果IP协议没有数据包大小的限制，那么上层可以以消息为单位传输数据，自然就不存在分片和组装的需求，不过因为物理设备的 MTU 限制，想要保证数据传输的可靠性和稳定性还需要传输层的配合。

#### TCP协议拆分数据：最大分段大小

TCP协议是面向字节流的协议，应用层交给TCP协议的数据并不会以消息为单位向目的主机发送，应用层交给TCP协议发送的数据可能会被拆分到多个数据段中。

TCP协议引入了最大分段大小（Maximum segment size，MSS）这一概念，它是TCP数据段能够携带的数据上限。在正常情况下，TCP连接的 MSS 是 MTU - 40 字节，即 1460 字节；
不过如果通信双方没有指定 MSS 的话，在默认情况下 MSS 的大小是536字节。

不同于IP协议的MTU受限于物理设备上的限制，它限制了路径能够发送数据包的上限，TCP协议的MSS是操作系统内核层面的限制，通信双方会在三次握手
时确定这次连接的MSS。一旦确定了MSS，TCP协议就会对应用层交给TCP协议发送的数据进行拆分，构成多个数据段。这两者差异还是很明显的，IP协议以
数据包为单位组织数据，TCP协议以数据段为单位组织数据。

TCP 协议为了保证可靠性，会通过IP协议的MTU计算出MSS并根据MSS分段避免IP协议对数据包进行分片。因为IP协议对数据包的分片对上层是透明的，如果协议不根据MTU
做一些限制，那么IP协议的分片会导致部分数据包失去传输层协议头，一旦数据包发生丢失就只能丢弃全部数据。

#### 最后BB两句

数据拆分的根本原因说到底还是物理设备的限制，不过每一层协议都受限于下一层协议做出的决定，并依赖下层协议重新决定设计和实现的方法。
虽然 TCP/IP 协议在传输数据时都需要对数据进行拆分，但是它们做出拆分数据的设计基于不同的上下文，也有着不同的目的。

-IP 协议拆分数据是因为物理设备的限制，一次能够传输的数据由路径上 MTU 最小的设备决定，一旦 IP 协议传输的数据包超过 MTU 的限制就会
发生分片，所以我们需要通过路径 MTU 发现获取传输路径上的 MTU 限制；
- TCP 协议拆分数据是为了保证传输的可靠性和顺序，作为可靠的传输协议，为了保证数据的传输顺序，它需要为每一个数据段增加包含序列号的
TCP协议头，如果数据段大小超过了IP协议的MTU限制， 就会带来更多额外的重传和重组开销，影响性能。




