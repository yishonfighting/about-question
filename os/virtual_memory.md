# 关于虚拟内存

说到操作系统，最常被提及的，总会是CPU、内存、虚拟内存...对于操作系统而言，CPU和主内存都是属于稀缺的资源，以至于所有运行在os中的进程都需要共享系统中的CPU和内存资源。os会使用CPU调度器来分配CPU的占用时间，并且引入虚拟内存来对物理内存进行管理。

那么虚拟内存是什么呢？

看过到一个比较形象对说明：__虚拟内存是os物理内存和进程之间对中间层__，它为进程隐藏了物理内存这一概念，为进程提供了更加简洁和易用的接口以及更加复杂的功能。

但是操作系统被设计之初，是没有使用到虚拟内存的，系统中的进程会直接访问主内存中的物理地址，访问内存中的内容。

这么设计看似简单直接，但是带来的问题也是致命的：

1. 因为进程地址空间没有隔离，不同程序可以互相访问到对方的物理内存，可以是有意也可以是无意；
2. 内存的使用效率低。在多个应用程序运行的时候，因为运行另外一个程序需要加载对应大小的内存才能运行，势必造成频繁的数据拷贝；
3. 程序运行的时候地址不确定，因为内存的分配是随机的

现代的操作系统都引入了虚拟内存，进程持有的虚拟地址会经过内存管理单元的转换变成物理地址，然后再通过物理地址（MMU）访问内存。
前面说到了，主存储是相对稀缺的资源，它在随机访问上提供了极快的处理时间，随机读取数据的时候会是磁盘的10W倍，不过呢，对于顺序读取优势就没有那么明显了，只领先了一个数量级。这些都得益于内存的分页设计。

os以页为单位管理内存，当进程发现需要访问的数据不在内存中的时候，会将数据以页的方式加载到内存中，也就是通过内存管理单元（MMU）来完成的，虚拟内存在中间起到了几个很关键的作用：

1. 虚拟内存可以为进程提供独立的内存空间，简化程序的连接、加载过程并通过动态库共享内存；
2. 虚拟内存可以利用内存起到缓存的作用，提高进程访问磁盘的速度；
3. 虚拟内存可以控制进程对物理内存的访问，隔离不同进程的访问权限，提高系统安全性

这三个点其实也是对应上面提出初代os的问题。

...未完待续